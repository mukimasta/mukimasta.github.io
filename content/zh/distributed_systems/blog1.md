---
author : ['Mukii']
title: "Distributed System Blog 01 â€“ Exactly-Once RPC"
description: "åœ¨ä¸å¯é ç½‘ç»œä¸Šå®ç° Exactly-Once RPC"
date: 2026-01-20
lastmod: 2026-01-20
type: post
draft: false
translationKey: distributed_systems_blog1
coffee: 3
tags: ['distributed_systems']
categories: ['distributed_systems']
---



# Distributed System Blog 01 â€“ Exactly-Once RPC

**åœ¨ä¸å¯é ç½‘ç»œä¸Šå®ç° Exactly-Once RPC**

## 0  å‰è¨€

### 0.1  åˆ†å¸ƒå¼ç³»ç»Ÿ

æˆ‘ä»¬æ¯å¤©éƒ½åœ¨ç”¨åˆ†å¸ƒå¼ç³»ç»Ÿï¼š
- æ‰“å¼€å¾®ä¿¡ â†’  ä½ çš„æ‰‹æœºè¿æ¥åˆ°è…¾è®¯çš„æœåŠ¡å™¨
- åˆ·æŠ–éŸ³     â†’  è§†é¢‘ä»å­—èŠ‚çš„æœåŠ¡å™¨ä¼ ç»™ä½ 
- ç½‘è´­         â†’  è®¢å•ä¿¡æ¯å­˜åœ¨é˜¿é‡Œçš„æ•°æ®åº“é‡Œ

**åˆ†å¸ƒå¼ç³»ç»Ÿ = å¤šä¸ªç‹¬ç«‹è®¡ç®—èŠ‚ç‚¹é€šè¿‡ç½‘ç»œåä½œå®ç°å…±åŒçš„ç›®æ ‡**

**ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼ç³»ç»Ÿï¼Ÿ**
- å•æœºè£…ä¸ä¸‹ï¼š Facebook æœ‰ 30 äº¿ç”¨æˆ·ï¼Œä¸€å°æœºå™¨å­˜ä¸ä¸‹æ‰€æœ‰æ•°æ®
- å•æœºæ‰›ä¸ä½ï¼š åŒåä¸€æ¯ç§’å‡ åä¸‡è®¢å•ï¼Œä¸€å°æœºå™¨å¤„ç†ä¸è¿‡æ¥
- å•æœºä¼šæŒ‚æ‰ï¼š æœåŠ¡å™¨ä¼šåï¼Œç¡¬ç›˜ä¼šçƒ§ï¼Œéœ€è¦å¤‡ä»½

ä½†å¤šå°æœºå™¨å¸¦æ¥äº†æ–°çš„é—®é¢˜ï¼šå®ƒä»¬ä¹‹é—´å¦‚ä½•é€šè¿‡ç½‘ç»œé€šä¿¡åä½œï¼Ÿ

### 0.2  Remote Procedure Call (RPC)

ä½ å¹³æ—¶ç”¨ appï¼š

```
ç‚¹å‡»æœ‹å‹å¤´åƒ â†’ çœ‹åˆ°ä¸ªäººèµ„æ–™
åˆ·æ–°æœ‹å‹åœˆ â†’ çœ‹åˆ°æœ€æ–°åŠ¨æ€
å‘é€æ¶ˆæ¯ â†’ å¯¹æ–¹æ”¶åˆ°
```

è¿™äº›æ“ä½œèƒŒåå°±åƒè°ƒç”¨äº†ä¸€ä¸ªè¿œç¨‹å‡½æ•°ã€‚

æƒ³è±¡ä½ åœ¨å†™ä»£ç ï¼š
```python
# æœ¬åœ°å‡½æ•°è°ƒç”¨
profile = get_profile(user_id)
```

è¿™ä¸ªå‡½æ•°åœ¨ä½ çš„ç¨‹åºé‡Œæ‰§è¡Œï¼Œè¯»å–æœ¬åœ°å†…å­˜çš„æ•°æ®ã€‚

ä½†å¦‚æœæ•°æ®åœ¨å¦ä¸€å°æœºå™¨ä¸Šå‘¢ï¼Ÿ

```python
# è¿œç¨‹å‡½æ•°è°ƒç”¨ï¼ˆRPCï¼‰
profile = remote_get_profile(user_id)
```

è¿™ä¸ªå‡½æ•°ï¼š
1. æŠŠè¯·æ±‚é€šè¿‡ç½‘ç»œå‘ç»™æœåŠ¡å™¨
2. æœåŠ¡å™¨æ‰§è¡Œå‡½æ•°
3. æŠŠç»“æœé€šè¿‡ç½‘ç»œå‘å›æ¥

çœ‹èµ·æ¥åªæ˜¯åŠ äº†ä¸ª "remote"ï¼Œä½†åŠ å…¥äº†ç½‘ç»œï¼Œä¸€åˆ‡éƒ½å˜äº†ã€‚

### 0.3  ä¸€ä¸ªè½¬è´¦çš„æ•…äº‹

æƒ³è±¡è¿™ä¸ªåœºæ™¯ï¼š
```
ä½ æ‰“å¼€æ‰‹æœº appï¼Œç»™æœ‹å‹è½¬è´¦ 100 å…ƒ
ç‚¹å‡»"ç¡®è®¤è½¬è´¦"
loading...
loading...
10 ç§’è¿‡å»äº†ï¼Œè¿˜åœ¨ loading
```

ä½ ä¼šæ€ä¹ˆåšï¼Ÿ
- å†ç‚¹ä¸€æ¬¡ï¼Ÿä¸‡ä¸€ç¬¬ä¸€æ¬¡æˆåŠŸäº†å‘¢ï¼Ÿé‚£å°±è½¬äº† 200 å…ƒ
- æ”¾å¼ƒï¼Ÿä¸‡ä¸€æ ¹æœ¬æ²¡è½¬æˆåŠŸå‘¢ï¼Ÿ
- ç­‰ç€ï¼Ÿç­‰åˆ°ä»€ä¹ˆæ—¶å€™ï¼Ÿ

**è¿™å°±æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ ¸å¿ƒå›°å¢ƒï¼šç½‘ç»œæ˜¯ä¸å¯é çš„**

### 0.4  ç½‘ç»œæœ‰å¤šä¸å¯é ï¼Ÿ

å‘é€"è½¬è´¦ 100 å…ƒ"åï¼Œæ²¡æ”¶åˆ°å›å¤ã€‚å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ
```
æƒ…å†µ1ï¼šè¯·æ±‚åœ¨è·¯ä¸Šä¸¢äº†
Client ----X---> Server
(Server æ ¹æœ¬æ²¡æ”¶åˆ°)

æƒ…å†µ2ï¼šServer æ‰§è¡Œäº†ï¼Œä½†å›å¤ä¸¢äº†
Client --------> Server âœ”ï¸
Client <---X---- Server
(é’±è½¬äº†ï¼Œä½†ä½ ä¸çŸ¥é“)

æƒ…å†µ3ï¼šç½‘ç»œå¾ˆæ…¢
Client ----ğŸ˜´---> Server ğŸ•’
(è¿˜åœ¨è·¯ä¸Šï¼Œçœ‹èµ·æ¥åƒä¸¢äº†)
```

**å…³é”®å›°å¢ƒï¼šä½ æ— æ³•åŒºåˆ†è¿™äº›æƒ…å†µï¼Œä¹Ÿæ— æ³•ä¿è¯æ¶ˆæ¯åˆ°è¾¾çš„é¡ºåºã€‚**

### 0.5  æˆ‘ä»¬çš„ç›®æ ‡ï¼šExactly-Once RPC

ä¸ç®¡ç½‘ç»œç¯å¢ƒå¦‚ä½•ï¼Œæˆ‘ä»¬æƒ³è¦ä¿è¯ï¼šæ¯ä¸ªæ“ä½œæ°å¥½æ‰§è¡Œä¸€æ¬¡ï¼ˆExactly-Onceï¼‰ã€‚

â€œExactly-Onceâ€æ€ä¹ˆå®ç°ï¼Ÿ

**Exactly-Once = At-Least-Once + At-Most-Once**

æ‹†å¼€æ¥çœ‹ï¼š
- **ä¸èƒ½æ˜¯ 0 æ¬¡** â†’ è‡³å°‘æ‰§è¡Œ 1 æ¬¡ï¼ˆAt-Least-Onceï¼‰
- **ä¸èƒ½æ˜¯ 2+ æ¬¡** â†’ è‡³å¤šæ‰§è¡Œ 1 æ¬¡ï¼ˆAt-Most-Onceï¼‰

## 1  At-Least-Once RPC

æˆ‘ä»¬å…ˆæ¥å®ç° At-Least-Once RPCï¼Œä¹Ÿå°±æ˜¯å…ˆä¿è¯æ¯ä¸ªæ“ä½œè¢« Server è‡³å°‘æ‰§è¡Œä¸€æ¬¡ï¼Œå¹¶ä¸” Client æ€»ä¼šæ”¶åˆ°æ‰§è¡Œç»“æœã€‚

At-Least-Once åœ¨ Client å±‚çº§ä¸Šå®ç°ã€‚

### 1.1  é‡è¯•æœºåˆ¶

æˆ‘ä»¬å…ˆæ¥è§£å†³ç¬¬ä¸€ç§æƒ…å†µï¼šè¯·æ±‚å¯èƒ½ä¸¢å¤±ï¼Œä¹Ÿå°±æ˜¯ Server æ²¡æœ‰æ”¶åˆ°è¯·æ±‚ï¼š
```
  Client    ----X--->    Server
è½¬è´¦ 100 å…ƒ  (ç½‘ç»œä¸¢åŒ…)  (æ ¹æœ¬æ²¡æ”¶åˆ°)

ç»“æœ: 0 æ¬¡æ‰§è¡Œ
```

æ€ä¹ˆåŠï¼Ÿ

ä¸€ä¸ªå¾ˆç›´è§‰çš„æƒ³æ³•æ˜¯ï¼šé‡è¯•

æˆ‘ä»¬æ¯é—´éš”ä¸€æ®µæ—¶é—´ï¼Œå°±é‡æ–°å‘é€ä¸€æ¬¡è¯·æ±‚ï¼Œç›´åˆ°æˆåŠŸæ”¶åˆ°å›å¤ä¸ºæ­¢ã€‚

```
  Client    ----X--->    Server
è½¬è´¦ 100 å…ƒ  (ç½‘ç»œä¸¢åŒ…)  (æ ¹æœ¬æ²¡æ”¶åˆ°)

  Client    -------->    Server
è½¬è´¦ 100 å…ƒ    (é‡è¯•)    (æˆåŠŸæ‰§è¡Œ)

  Client    <--------    Server
 (æ”¶åˆ°å›å¤)              (å›å¤ç»“æœ)

ç»“æœ: 1 æ¬¡æ‰§è¡Œ
```

çœ‹èµ·æ¥å¾ˆåˆç†ï¼Œä½†æ˜¯ï¼Œè¿™æ ·ä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ã€‚

è€ƒè™‘è¿™ä¸ªåœºæ™¯ï¼š

```
æ—¶åˆ» T1: Client å‘é€ "è½¬è´¦ 100"
æ—¶åˆ» T2: (è¶…æ—¶ï¼Œæ²¡å›å¤)
æ—¶åˆ» T3: Client é‡è¯•ï¼Œå†æ¬¡å‘é€ "è½¬è´¦ 100"
æ—¶åˆ» T4: Server å›å¤ "æˆåŠŸ"
æ—¶åˆ» T5: Client å‘é€æ–°å‘½ä»¤ "æŸ¥è¯¢ä½™é¢"
æ—¶åˆ» T6: Server å›å¤ "æˆåŠŸ"

é—®é¢˜: è¿™ä¸ª "æˆåŠŸ" æ˜¯å“ªä¸ªå‘½ä»¤çš„å›å¤ï¼Ÿ
- è½¬è´¦çš„å›å¤ï¼Ÿ
- æŸ¥è¯¢ä½™é¢çš„å›å¤ï¼Ÿ
```

å¦‚æœ Client è¯¯ä»¥ä¸º"æˆåŠŸ"æ˜¯"æŸ¥è¯¢ä½™é¢"çš„å›å¤ï¼Œä½†å…¶å®æ˜¯ç¬¬ä¸€æ¬¡"è½¬è´¦"çš„å»¶è¿Ÿå›å¤ï¼Œç³»ç»Ÿå°±ä¹±äº†ã€‚

**é—®é¢˜æœ¬è´¨ï¼šå›å¤å’Œè¯·æ±‚å¤±å»äº†å¯¹åº”å…³ç³»ã€‚**

### 1.2  RequestID è¯·æ±‚æ ‡è¯†

æ€ä¹ˆå»ºç«‹å¯¹åº”å…³ç³»ï¼Ÿç»™æ¯ä¸ªè¯·æ±‚æ‰“æ ‡ç­¾ã€‚

æ ‡ç­¾éœ€è¦æ»¡è¶³ï¼š

- é‡è¯•æ—¶ä¿æŒä¸å˜ï¼ˆè¿™æ ·æ‰çŸ¥é“æ˜¯åŒä¸€ä¸ªè¯·æ±‚ï¼‰
- æ–°å‘½ä»¤æ—¶æ”¹å˜ï¼ˆè¿™æ ·æ‰èƒ½åŒºåˆ†ä¸åŒè¯·æ±‚ï¼‰

**è‡ªç„¶çš„é€‰æ‹©ï¼šé€’å¢çš„ request_id**

```
Client ç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨:
request_id = 0

å‘é€æ–°å‘½ä»¤:
  request_id += 1
  å‘é€ (request_id, command)

é‡è¯•æ—¶:
  å‘é€ç›¸åŒçš„ (request_id, command)
  (request_id ä¸å˜ï¼)
```

Server çš„å›å¤ä¹Ÿå¿…é¡»å¸¦ä¸Š request_idï¼Œå¦åˆ™ Client æ— æ³•åŒ¹é…ã€‚

å…·ä½“åœºæ™¯ï¼š

```
T1: Client å‘é€ (request_id=1, "è½¬è´¦ 100")
T2: (è¶…æ—¶ï¼Œå‡†å¤‡é‡è¯•) 
T3: Client å‘é€ (request_id=1, "è½¬è´¦ 100")  â† ID ä¸å˜
T4: Server å›å¤ (request_id=1, "æˆåŠŸ")
T5: Client å‘é€ (request_id=2, "æŸ¥è¯¢ä½™é¢") â† ID é€’å¢
T6: Server å›å¤ (request_id=1, "æˆåŠŸ")

Client æ£€æŸ¥: request_id=1 â‰  å½“å‰çš„ request_id=2
â†’ è¿™æ˜¯æ—§å›å¤ï¼Œå¿½ç•¥
â†’ ç»§ç»­ç­‰å¾… request_id=2 çš„å›å¤
```

å®Œæ•´çš„æ¶ˆæ¯æ ¼å¼ï¼š

```
Request:
  request_id: ç¬¬å‡ ä¸ªè¯·æ±‚
  command:    è¦æ‰§è¡Œä»€ä¹ˆ

Reply:
  request_id: å›å¤å“ªä¸ªè¯·æ±‚
  result:     æ‰§è¡Œç»“æœ
```

### 1.3  At-Least-Once çš„å®Œæ•´é€»è¾‘ï¼š

```
Client çš„çŠ¶æ€:
- current_request_id: å½“å‰è¯·æ±‚çš„ ID
- current_command:    å½“å‰è¯·æ±‚çš„å‘½ä»¤
- timer:              é‡è¯•å®šæ—¶å™¨

å‘é€æ–°å‘½ä»¤:
  current_request_id += 1
  current_command = command
  å‘é€ Request(current_request_id, command)
  å¯åŠ¨ timer

æ”¶åˆ°å›å¤ Reply(reply_request_id, result):
  if reply_request_id == current_request_id:
      åœæ­¢ timer
      è¿”å› result
  else:
      å¿½ç•¥ (è¿™æ˜¯æ—§è¯·æ±‚çš„å›å¤)

Timer è¶…æ—¶:
  é‡å‘ Request(current_request_id, current_command)
  é‡å¯ timer
```


**è‡³æ­¤ï¼Œæˆ‘ä»¬å®ç°äº† At-Least-Onceï¼šåªè¦ Client ä¸åœé‡è¯•ï¼Œè¯·æ±‚æœ€ç»ˆä¼šåˆ°è¾¾å¹¶æ‰§è¡Œï¼ŒClient æœ€ç»ˆä¼šæ”¶åˆ°å›å¤ã€‚**


## 2  At-Most-Once RPC

Client é‡è¯•ä¼šå¯¼è‡´ Server æ”¶åˆ°å¤šä¸ªç›¸åŒçš„è¯·æ±‚ã€‚æˆ‘ä»¬å³å°†å®ç°çš„ At-Most-Once éœ€è¦ä¿è¯æ¯ä¸ªè¯·æ±‚åªè¢«æ‰§è¡Œä¸€æ¬¡ã€‚

At-Most-Once åœ¨ Server å±‚çº§ä¸Šå®ç°ã€‚

### 2.1  å»é‡æœºåˆ¶

Server æ€ä¹ˆçŸ¥é“è¿™æ˜¯é‡å¤è¯·æ±‚ï¼Ÿ

ç”¨æˆ‘ä»¬å·²æœ‰çš„ä¸œè¥¿ï¼š**request_id**

```
Server ç»´æŠ¤ä¸€ä¸ªè®°å½•:
seen = {1, 2, 5, 7, ...}

æ”¶åˆ°è¯·æ±‚ Request(request_id, command):
  if request_id in seen:
      è¿™æ˜¯é‡å¤è¯·æ±‚
      ...
  else:
      è¿™æ˜¯æ–°è¯·æ±‚
      ...
```

å¯¹äºå¤šä¸ª Client çš„æƒ…å†µï¼š

Server çš„è®°å½•çš„ Key å˜æˆ (client_id, request_id)ï¼š

åœ¨ç½‘ç»œé€šä¿¡ä¸­ï¼Œæ¯ä¸ªæ¶ˆæ¯å¤©ç„¶å°±å¸¦æœ‰å‘é€è€…çš„åœ°å€ï¼ˆaddressï¼‰ã€‚æˆ‘ä»¬ç›´æ¥ç”¨è¿™ä¸ªåœ°å€ä½œä¸º client_id å³å¯ã€‚

æ‰€ä»¥ä¸€ä¸ªè¯·æ±‚çš„å®Œæ•´çš„å”¯ä¸€æ ‡è¯†æ˜¯ï¼š(client_id, request_id)ï¼Œè¿™ä¹Ÿæ˜¯åœ¨ Server å±‚è¦ç»´æŠ¤çš„è®°å½•ã€‚
å…¶ä¸­ï¼š
- **client_id**ï¼šç”±ç½‘ç»œæ¡†æ¶æä¾›ï¼ˆå‘é€è€…çš„åœ°å€ï¼‰
- **request_id**ï¼šç”±æˆ‘ä»¬çš„åº”ç”¨å±‚ç»´æŠ¤ï¼ˆé€’å¢åºåˆ—å·ï¼‰

### 2.2  è¯·æ±‚ â†’ ç»“æœ æ˜ å°„è¡¨

åœ¨æ¥æ”¶åˆ°é‡å¤è¯·æ±‚åï¼Œè¦æ€ä¹ˆåšï¼Ÿ

```
T1: Client å‘é€ Request(request_id=1, command)
    Server æ‰§è¡Œï¼Œå›å¤ä¸¢å¤±

T2: Client é‡è¯•ï¼Œå‘é€ Request(request_id=1, command)
    Server å‘ç°: ä¹‹å‰è§è¿‡ (client_id, 1)
    ç„¶åå‘¢ï¼Ÿ
```

Server ä¸èƒ½ï¼š
- é‡æ–°æ‰§è¡Œ â†’ è¿å at-most-once
- ä¸å›å¤ â†’ Client ä¼šä¸€ç›´ç­‰

**Server å¿…é¡»ï¼šè¿”å›ä¹‹å‰çš„ç»“æœ**

å¯¹äºæ¯ä¸ªè¯·æ±‚ (client_id, request_id)ï¼Œä¿å­˜å¯¹åº”çš„ç»“æœã€‚

**HashMap: (client_id, request_id) -> Result**

ä½¿ç”¨ä¸€ä¸ªâ€œè¯·æ±‚ â†’ ç»“æœâ€æ˜ å°„è¡¨ï¼Œæ”¶åˆ°æ—§è¯·æ±‚æ—¶è¿”å›å³å¯ã€‚

Server ä¸èƒ½æ— é™ä¿å­˜å†å²ã€‚

### 2.3  å•è¯·æ±‚å‡è®¾ä¸‹çš„åƒåœ¾å›æ”¶æœºåˆ¶

Client å•è¯·æ±‚å‡è®¾ï¼šClient åœ¨æœªæ”¶åˆ°å½“å‰è¯·æ±‚çš„å›å¤ä¹‹å‰ä¸ä¼šè¯·æ±‚æ–°å‘½ä»¤ã€‚

```
Client çš„è¡Œä¸º:
å‘é€ req=1 â†’ ç­‰å›å¤ â†’ æ”¶åˆ°
å‘é€ req=2 â†’ ç­‰å›å¤ â†’ æ”¶åˆ°
å‘é€ req=3 â†’ ...
```

åœ¨æ­¤æƒ…å†µä¸‹ï¼š
```
Client å‘é€äº† request_id=N+1
â†’ è¯´æ˜å®ƒå·²ç»æ”¶åˆ°äº† request_idâ‰¤N çš„å›å¤
â†’ Server å¯ä»¥ä¸¢å¼ƒ request_idâ‰¤N çš„è®°å½•
```

æ‰€ä»¥åªéœ€ä¿å­˜æœ€åä¸€ä¸ªï¼š
```
history = {
  client_A: (last_id, last_result),
  client_B: (last_id, last_result),
}

æ”¶åˆ°æ–°è¯·æ±‚ N:
  history[client_id] = (N, result)
  // è‡ªåŠ¨è¦†ç›–æ—§çš„ï¼Œåªä¿ç•™æœ€æ–°
```

**HashMap: client_id -> (request_id, Result)**

### 2.4  At-Most-Once çš„å®Œæ•´é€»è¾‘

```
Server çš„çŠ¶æ€:
- history: map[client_id â†’ (last_request_id, last_result)]

æ”¶åˆ°è¯·æ±‚ Request(request_id, command) æ¥è‡ª client_id:
  
  record = history.get(client_id)
  
  if record ä¸å­˜åœ¨:
      // ç¬¬ä¸€æ¬¡è§åˆ°è¿™ä¸ª Client
      result = execute(command)
      history[client_id] = (request_id, result)
      å‘é€ Reply(request_id, result)
      return
  
  if request_id <= record.last_request_id:
      // é‡å¤æˆ–ä¹±åºçš„æ—§è¯·æ±‚
      å‘é€ Reply(request_id, record.last_result)
      return
  
  // æ–°è¯·æ±‚ (request_id > last_request_id)
  result = execute(command)
  history[client_id] = (request_id, result)  // è¦†ç›–æ—§è®°å½•
  å‘é€ Reply(request_id, result)
```


## 3  Exactly-Once RPC å®Œæ•´æ¶æ„

```
Client èŠ‚ç‚¹                    Server èŠ‚ç‚¹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Retry Logic  â”‚   Command    â”‚ AMOApplication â”‚
â”‚    (ALO)     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚     (AMO)      â”‚
â”‚              â”‚    Result    â”‚       â†“        â”‚
â”‚              â”‚  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  Application   â”‚
â”‚              â”‚              â”‚   (business)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è¯¦ç»†ç‰ˆæœ¬ï¼š

```
Client Node                              Server Node
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Retry Logic (ALO impl)  â”‚             â”‚ AMOApplication (AMO impl)â”‚
â”‚                         â”‚             â”‚                          â”‚
â”‚ â€¢ request_id: 1,2,3...  â”‚  Command    â”‚ â€¢ Dedup check:           â”‚
â”‚ â€¢ Timer: retry timeout  â”‚  +request_idâ”‚   req_id <= last_req_id? â”‚
â”‚ â€¢ Match reply: ID match?â”‚             â”‚                          â”‚
â”‚                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚ â€¢ Save history:          â”‚
â”‚                         â”‚             â”‚   map[client_idâ†’         â”‚
â”‚                         â”‚             â”‚       (req_id, result)]  â”‚
â”‚                         â”‚  Result     â”‚                          â”‚
â”‚                         â”‚  +request_idâ”‚   â†“ if new request       â”‚
â”‚ Match â†’ stop retry      â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                          â”‚
â”‚                         â”‚             â”‚ Application (Business)   â”‚
â”‚                         â”‚             â”‚ â€¢ Get/Put/Append         â”‚
â”‚                         â”‚             â”‚ â€¢ Transfer/Query         â”‚
â”‚                         â”‚             â”‚ â€¢ ... (any business)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘                                         â†‘
client_id provided by network          Get client_id from message
framework (sender address)             (sender address)
```

**Server å†…éƒ¨åˆ†å±‚ï¼ˆæ€ä¹ˆåšï¼‰**

```
Server å†…éƒ¨:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AMOApplication     â”‚ â† å»é‡å±‚
â”‚      (åŒ…è£…)          â”‚   åªå…³å¿ƒ request_id
â”‚                     â”‚   ä¸å…³å¿ƒä¸šåŠ¡é€»è¾‘
â”‚        â†“            â”‚
â”‚  Application        â”‚ â† ä¸šåŠ¡å±‚
â”‚   (å…·ä½“ä¸šåŠ¡)          â”‚   åªå…³å¿ƒä¸šåŠ¡é€»è¾‘
â”‚  â€¢ KVStore          â”‚   ä¸å…³å¿ƒå»é‡
â”‚  â€¢ GameServer       â”‚
â”‚  â€¢ ShoppingCart     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##  4  æ‹“å±•å»¶ä¼¸


ä¸æ˜¯æ‰€æœ‰æ“ä½œéƒ½æ€•é‡å¤

### 4.1  Side Effect å’Œ Idempotence


**Side Effect = æ”¹å˜ç³»ç»ŸçŠ¶æ€çš„æ“ä½œ**

```
æ— å‰¯ä½œç”¨ (è¯»æ“ä½œ):
- GET(key)          - åªè¯»ï¼Œä¸æ”¹å˜çŠ¶æ€
- QUERY_BALANCE()   - åªè¯»ï¼Œä¸æ”¹å˜çŠ¶æ€

æœ‰å‰¯ä½œç”¨ (å†™æ“ä½œ):
- PUT(key, value)   - ä¿®æ”¹çŠ¶æ€
- TRANSFER(amount)  - ä¿®æ”¹çŠ¶æ€
- APPEND(key, val)  - ä¿®æ”¹çŠ¶æ€
```

å¦‚æœæ“ä½œæœ‰å‰¯ä½œç”¨ï¼Œé‡å¤æ‰§è¡Œå¯èƒ½äº§ç”Ÿé”™è¯¯çš„ç»“æœã€‚

**Idempotenceï¼ˆå¹‚ç­‰æ€§ï¼‰= æ‰§è¡Œå¤šæ¬¡å’Œæ‰§è¡Œä¸€æ¬¡çš„æ•ˆæœç›¸åŒ**

```
å¹‚ç­‰æ“ä½œ:
- GET(key)            - è¯»å¤šæ¬¡ç»“æœä¸€æ ·
- PUT(key, "value")   - è®¾ç½®æˆå›ºå®šå€¼ï¼Œé‡å¤è®¾ç½®è¿˜æ˜¯é‚£ä¸ªå€¼
- DELETE(key)         - åˆ é™¤ï¼ˆåˆ é™¤å·²åˆ é™¤çš„ = è¿˜æ˜¯åˆ é™¤ï¼‰

éå¹‚ç­‰æ“ä½œ:
- APPEND(key, value)  - æ¯æ¬¡è¿½åŠ ï¼Œè¶Šæ¥è¶Šé•¿
- INCREMENT(counter)  - æ¯æ¬¡åŠ  1ï¼Œè¶Šæ¥è¶Šå¤§
- TRANSFER(amount)    - æ¯æ¬¡æ‰£é’±ï¼Œè¶Šæ¥è¶Šå°‘
```

**ä¸ºä»€ä¹ˆé‡è¦ï¼Ÿ**

å¦‚æœæ“ä½œæ˜¯å¹‚ç­‰çš„ï¼Œç³»ç»Ÿå¯ä»¥ç®€åŒ–ï¼š

```
Client: ä¸ç¡®å®šæ˜¯å¦æˆåŠŸï¼Ÿç›´æ¥é‡è¯•å°±è¡Œ
Server: é‡å¤æ‰§è¡Œä¹Ÿæ²¡äº‹
â†’ ä¸éœ€è¦å¤æ‚çš„ AMO æœºåˆ¶ï¼Œat-least-once å°±å¤Ÿäº†
```

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ DNSã€NFS ç­‰ç³»ç»Ÿèƒ½ç”¨ç®€å•çš„ at-least-onceã€‚

### 4.2 æˆ‘ä»¬çš„æ–¹æ¡ˆé€‚ç”¨èŒƒå›´

é€‚ç”¨äºï¼š
- éå¹‚ç­‰æ“ä½œï¼ˆéœ€è¦ AMO ä¿æŠ¤ï¼‰
    - APPENDã€INCREMENTã€TRANSFER ç­‰
- Client å•è¯·æ±‚æ¨¡å¼ï¼ˆåƒåœ¾å›æ”¶ä¾èµ–è¿™ä¸ªå‡è®¾ï¼‰
    - ä¸€ä¸ª Client ä¸€æ¬¡åªå‘ä¸€ä¸ªè¯·æ±‚
- æœ‰çŠ¶æ€æœåŠ¡ï¼ˆéœ€è¦è®°ä½å†å²ï¼‰
    - éœ€è¦æŒä¹…åŒ–å­˜å‚¨çš„æœåŠ¡

## 5  ç»“è¯­

Lab 1 çœ‹èµ·æ¥å¾ˆç®€å•ï¼šå®ç°ä¸€ä¸ª RPCã€‚

ä½†å®ƒæ­ç¤ºäº†åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ ¸å¿ƒæŒ‘æˆ˜ï¼š**å¦‚ä½•åœ¨ä¸ç¡®å®šæ€§ä¸­æ„å»ºç¡®å®šæ€§ï¼Ÿ**

æˆ‘ä»¬çš„ç­”æ¡ˆä¸æ˜¯æ¶ˆé™¤ä¸ç¡®å®šæ€§ï¼ˆåšä¸åˆ°ï¼‰ï¼Œè€Œæ˜¯ï¼š

- æ‰¿è®¤ç½‘ç»œä¸å¯é 
- åˆ†è§£é—®é¢˜ï¼ˆexactly-once = at-least + at-mostï¼‰
- åˆ†å±‚è®¾è®¡ï¼ˆClient é‡è¯• + Server å»é‡ï¼‰
- åˆ©ç”¨å‡è®¾ï¼ˆå•è¯·æ±‚ â†’ åƒåœ¾å›æ”¶æœºåˆ¶ï¼‰
- ç”¨ç®€å•æœºåˆ¶ç»„åˆæˆå¤æ‚ä¿è¯

è¿™ä¸ä»…ä»…æ˜¯ä¸€ä¸ª Lab çš„è§£æ³•ï¼Œæ›´æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡çš„åŸºæœ¬å“²å­¦ã€‚

ä¸‹ä¸€æ­¥ï¼šLab 2 ä¼šå¼•å…¥ Primary-Backupï¼Œåœ¨ä¸å¯é çš„æœåŠ¡å™¨ä¸Šå®ç°å¯é çš„æœåŠ¡ã€‚